Details on PSyClone for CROCO OpenACC
=====================================

This page aimed at describing in a bit more details what I did to port CROCO
on GPU via PSyClone. It doesn't contains all the details but draw the
big picture.

PSyClone use
------------

The approach use the `psyclone` command (as described in
[using-psyclone.md](./using-psyclone.md)) to run some transformation scripts.

Original branch
---------------

The work has been started from the `dev2022_GPU_merge` GPU branch which 
already contains a manual port to OpenACC so I was able to progress file
by file to reproduce with PSyClone what has been done by hand.

Strictly speeking we might want at the end to rebase on the master and
not keeping to manual version (or not...).

Not yet auto-patched : vars push/pop - GPU IO
---------------------------------------------

As I worked on the manual GPU branch I kept the patched files allocating,
uploading, download the variables from/to the GPU as they are.

We might at a time reproduce those files with PSyClone which are:

- `copy_to_devices.F`: Need to auto list the variables and ACC instructions.
- `exchange_device_host.F`: Need to auto list the variables and ACC instructions.

For the IO to disks:

- `wrt_his.F`: Need to auto list the variables and ACC instructions.
- `wrt_rst.F`: Need to auto list the variables and ACC instructions.

Some of thors files are currently auto-generated by some handmade 
python script. To be seen if there is meaning in porting that into
a PSyClone based approach.

Skipping the manual ACC on some files
-------------------------------------

As I'm reusing part of the manual ACC version, I need to enable the
`OPENACC` cpp key which trigger the ACC pragmas in the non handled files.

It means that some loops are already reshaped in the whole sources.

A I want to keep the loop reshaping in psyclone, I needed to first
disable the `OPENACC` key before applying `psyclone` on the related files.

This is currently done by `psyclone.preprocessor.skip.acc.py` which is
a kind of dirty hack that we might trash when the work will be finished and
if we decide to trash the manual ACC version.

Compiler wrapper
----------------

I needed to explore various way of tuning the transformation scripts
to I made a compiler wrapper to ease the integration in the build pipeling.

This this is explained in [compiler-wrapper.md](compiler-wrapper.md).

Poseidon
--------

You will notice the `poseidon` directory in `scripts`. It currently contains
more code than strictly required because it is use for some exploration and
for other prospective researches.
We might need to shrink it to minimum when the work will be finished.
