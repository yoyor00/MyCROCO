# ci croco
stages:
  - bench
  - report

variables:
  DATAROOTPATH: "/data"


debug_base:
  stage: bench
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/debian_gfortran:2.0.0
  script:
    - cd $CI_PROJECT_DIR/BENCH
    - source /venv/bin/activate
    - |
      ./bench-croco.py \
      --case @base,@nbq,@sediment_mustang,@other \
      --variants @debug \
      --title debug \
      --debug \
      --rebuild \
      --host host_ci \
      --html \
      -N --report --no_date_in_result_dir
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week
    reports:
      junit: BENCH/results/debug-host_ci/junit_report.xml

plotphy_base:
  stage: bench
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/debian_gfortran:2.0.0
  script:
    - cd $CI_PROJECT_DIR/BENCH
    - source /venv/bin/activate
    - |
      ./bench-croco.py \
      --case @base,@nbq,@sediment_mustang,@other \
      --variants mpi-2 \
      --title plotphy \
      -s build,run,plotphy \
      --rebuild \
      --host host_ci \
      --html \
      -N --report --no_date_in_result_dir
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week
    reports:
      junit: BENCH/results/plotphy-host_ci/junit_report.xml
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"

debug_ifort:
  stage: bench
  tags:
    - ci.inria.fr
    - largelarge_more_disk
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/ubuntu_intel_parallel:test
  script:
    - ulimit -s unlimited
    - cd $CI_PROJECT_DIR/BENCH
    #note : check step done on sequential-ifort
    - |
      ./bench-croco.py \
      --case @base,@nbq,@sediment_mustang,@other,@realist \
      --variants @debug-ifort \
      --compare-to sequential-ifort \
      --title debug_ifort \
      --debug \
      --rebuild \
      --host host_ci \
      --data-root-path $DATAROOTPATH \
      --html -N --report --no_date_in_result_dir
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week
    reports:
      junit: BENCH/results/debug_ifort-host_ci/junit_report.xml
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"


debug_vortex:
  stage: bench
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/debian_gfortran:2.0.0
  script:
    - cd $CI_PROJECT_DIR/BENCH
    - source /venv/bin/activate
    - |
      ./bench-croco.py \
      --case VORTEX* \
      --variants sequential,mpi-4 \
      --debug \
      --title vortex \
      --rebuild \
      --host host_ci \
      --html \
      -N --report --no_date_in_result_dir
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week
    reports:
      junit: BENCH/results/vortex-host_ci/junit_report.xml


plotphy_vortex:
  stage: bench
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/debian_gfortran:2.0.0
  script:
    - cd $CI_PROJECT_DIR/BENCH
    - source /venv/bin/activate
    - |
      ./bench-croco.py \
      --case VORTEX* \
      --variants mpi-4 \
      --title plotphy_vortex \
      -s build,run,plotphy \
      --rebuild \
      --host host_ci \
      --html \
      -N --report --no_date_in_result_dir
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week
    reports:
      junit: BENCH/results/plotphy_vortex-host_ci/junit_report.xml
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"


debug_realist_base:
  stage: bench
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/ubuntu_gfortran_parallel:test
  script:
    - cd $CI_PROJECT_DIR/BENCH
    - |
      ./bench-croco.py \
      --case @realist_base \
      --variants sequential,mpi-4 \
      --title debug_realist_base \
      --debug \
      --rebuild \
      --host host_ci \
      --data-root-path $DATAROOTPATH \
      --html -N --report --no_date_in_result_dir
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week
    reports:
      junit: BENCH/results/debug_realist_base-host_ci/junit_report.xml

debug_realist:
  stage: bench
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/ubuntu_gfortran_parallel:test
  script:
    - cd $CI_PROJECT_DIR/BENCH
    - |
      ./bench-croco.py \
      --case @realist \
      --variants sequential,mpi-4 \
      --title debug_realist \
      --debug \
      --rebuild \
      --host host_ci \
      --data-root-path $DATAROOTPATH \
      --html -N --report --no_date_in_result_dir
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week
    reports:
      junit: BENCH/results/debug_realist-host_ci/junit_report.xml
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"

# space disk issue if we want to do restart on all realist cases
# to split ?
restart_realist:
  stage: bench
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/ubuntu_gfortran_parallel:test
  script:
    - cd $CI_PROJECT_DIR/BENCH
    - |
      ./bench-croco.py \
      --case @realist \
      --variants mpi-4 \
      --compare-to mpi-4 \
      --title restart_realist \
      --restart \
      --rebuild \
      --host host_ci \
      --data-root-path $DATAROOTPATH \
      --html -N --report --no_date_in_result_dir
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week
    reports:
      junit: BENCH/results/restart_realist-host_ci/junit_report.xml
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"


plotphy_realist:
  stage: bench
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/ubuntu_gfortran_parallel:test
  script:
    - cd $CI_PROJECT_DIR/BENCH
    - |
      ./bench-croco.py \
      --case BENGUELA_LR_TIDES_BULK \
      --variants mpi-4 \
      --title plotphy_realist \
      -s build,run,plotphy \
      --rebuild \
      --host host_ci \
      --data-root-path $DATAROOTPATH \
      --html -N --report --no_date_in_result_dir
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week
    reports:
      junit: BENCH/results/plotphy_realist-host_ci/junit_report.xml
  rules:
      - if: $CI_PIPELINE_SOURCE == "schedule"



debug_agrif_realist:
  stage: bench
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/ubuntu_gfortran_parallel:test
  script:
    - cd $CI_PROJECT_DIR/BENCH
    - |
      ./bench-croco.py \
      --case @agrif_realist \
      --variants sequential,mpi-4 \
      --title debug_agrif_realist \
      --debug \
      --rebuild \
      --host host_ci \
      --data-root-path $DATAROOTPATH \
      --html -N --report --no_date_in_result_dir
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week
    reports:
      junit: BENCH/results/debug_agrif_realist-host_ci/junit_report.xml


debug_complement:
  stage: bench
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/debian_gfortran:2.0.0
  script:
    - cd $CI_PROJECT_DIR/BENCH
    - source /venv/bin/activate
    - |
      ./bench-croco.py \
      --case @complement \
      --variants @debug \
      --title debug-complement \
      --debug \
      --rebuild \
      --host host_ci \
      --html \
      -N --report --no_date_in_result_dir
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week
    reports:
      junit: BENCH/results/debug-complement-host_ci/junit_report.xml
  rules:
      - if: $CI_PIPELINE_SOURCE == "schedule"


plotphy_complement:
  stage: bench
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/debian_gfortran:2.0.0
  script:
    - cd $CI_PROJECT_DIR/BENCH
    - source /venv/bin/activate
    - |
      ./bench-croco.py \
      --case @complement \
      --variants mpi-2 \
      --title plotphy-complement \
      -s build,run,plotphy \
      --rebuild \
      --host host_ci \
      --html \
      -N --report --no_date_in_result_dir
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week
    reports:
      junit: BENCH/results/plotphy-complement-host_ci/junit_report.xml
  rules:
      - if: $CI_PIPELINE_SOURCE == "schedule"


plotphy_complement_sequential:
  stage: bench
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/debian_gfortran:2.0.0
  script:
    - cd $CI_PROJECT_DIR/BENCH
    - source /venv/bin/activate
    - |
      ./bench-croco.py \
      --case @complement_sequential_only \
      --variants sequential \
      --title plotphy-complement-sequential \
      -s build,run,plotphy \
      --rebuild \
      --host host_ci \
      --html \
      -N --report --no_date_in_result_dir
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week
    reports:
      junit: BENCH/results/plotphy-complement-sequential-host_ci/junit_report.xml
  rules:
      - if: $CI_PIPELINE_SOURCE == "schedule"


track_perf:
  stage: bench
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/ubuntu_gfortran_parallel:test
  script:
    - cd $CI_PROJECT_DIR/BENCH
    - |
      mkdir -p previous
      cd $CI_PROJECT_DIR/BENCH/previous
      echo "Project ID: $CI_PROJECT_ID"
      echo "Commit Ref: $CI_COMMIT_REF_NAME"
      echo "Downloading artifacts for job: track_perf"

      curl --fail --location --output artifacts.zip \
          --header "JOB-TOKEN: $CI_JOB_TOKEN" \
          "https://gitlab.inria.fr/api/v4/projects/${CI_PROJECT_ID}/jobs/artifacts/${CI_COMMIT_REF_NAME}/download?job=track_perf" \
          || echo "No artifact available. Continuing without previous data."

      if [ -f artifacts.zip ]; then
          unzip artifacts.zip
      else
          echo "No artifacts.zip to unzip."
      fi
    - cd $CI_PROJECT_DIR/BENCH
    - |
      ./bench-croco.py \
      --case BASIN,BENGUELA_LR_TIDES_BULK \
      --variants sequential,mpi-4 \
      --title track-perf \
      -s build,run,plotperf,trackperf \
      -l $CI_PROJECT_DIR/BENCH/previous/BENCH/results/track-perf-host_ci/trackperf_summary.csv \
      --rebuild \
      --data-root-path $DATAROOTPATH \
      --host host_ci \
      --html \
      -N --report --no_date_in_result_dir
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 month
    reports:
      junit: BENCH/results/track-perf-host_ci/junit_report.xml


pages:
  stage: report
  tags:
    - ci.inria.fr
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/debian_gfortran:2.0.0
  script:
    - mkdir -p $CI_PROJECT_DIR/public/dev
    - cd $CI_PROJECT_DIR/BENCH
    - source /venv/bin/activate
    - ./bench-croco.py --globalhtml
    - cp -R $CI_PROJECT_DIR/BENCH/results $CI_PROJECT_DIR/public/dev
  artifacts:
    paths:
      - public
    when: always
    expire_in: 1 week
  when: always


