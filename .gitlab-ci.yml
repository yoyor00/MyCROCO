# ci croco
stages:
  - bench
  - report

variables:
  DATAROOTPATH: "/data"


debug_base:
  stage: bench
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/debian_gfortran:2.0.0
  script:
    - cd $CI_PROJECT_DIR/BENCH
    - source /venv/bin/activate
    - |
      ./bench-croco.py \
      --case @base,@nbq,@sediment_mustang,@other \
      --variants @debug \
      --title debug \
      --debug \
      --rebuild \
      --host host_ci \
      --html \
      -N --report --no_date_in_result_dir
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week
    reports:
      junit: BENCH/results/debug-host_ci/junit_report.xml

plotphy_base:
  stage: bench
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/debian_gfortran:2.0.0
  script:
    - cd $CI_PROJECT_DIR/BENCH
    - source /venv/bin/activate
    - |
      ./bench-croco.py \
      --case @base,@nbq,@sediment_mustang,@other \
      --variants mpi-2 \
      --title plotphy \
      -s build,run,plotphy \
      --rebuild \
      --host host_ci \
      --html \
      -N --report --no_date_in_result_dir
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week
    reports:
      junit: BENCH/results/plotphy-host_ci/junit_report.xml

debug_ifort:
  stage: bench
  tags:
    - croco-vm-docker
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/ubuntu_intel_parallel:2.0.0
  script:
    - cd $CI_PROJECT_DIR/BENCH
    #note : check step not available because sequential is not done here
    - |
      ./bench-croco.py \
      --case @base,@realist \
      --variants @debug-ifort \
      --title debug_ifort \
      --debug \
      --rebuild \
      --host host_ci \
      --steps build,run  \
      --data-root-path $DATAROOTPATH \
      --html -N --report --no_date_in_result_dir
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week
    reports:
      junit: BENCH/results/debug_ifort-host_ci/junit_report.xml
  when: manual

debug_vortex:
  stage: bench
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/debian_gfortran:2.0.0
  script:
    - cd $CI_PROJECT_DIR/BENCH
    - source /venv/bin/activate
    - |
      ./bench-croco.py \
      --case VORTEX* \
      --variants sequential,mpi-4 \
      --title vortex \
      --rebuild \
      --host host_ci \
      --html \
      -N --report --no_date_in_result_dir
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week
    reports:
      junit: BENCH/results/vortex-host_ci/junit_report.xml

debug_realist_base:
  stage: bench
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/ubuntu_gfortran_parallel:2.0.0
  script:
    - cd $CI_PROJECT_DIR/BENCH
    - |
      ./bench-croco.py \
      --case @realist_base \
      --variants sequential,mpi-4 \
      --title debug_realist_base \
      --debug \
      --rebuild \
      --host host_ci \
      --data-root-path $DATAROOTPATH \
      --html -N --report --no_date_in_result_dir
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week
    reports:
      junit: BENCH/results/debug_realist_base-host_ci/junit_report.xml

debug_realist:
  stage: bench
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/ubuntu_gfortran_parallel:2.0.0
  script:
    - cd $CI_PROJECT_DIR/BENCH
    - |
      ./bench-croco.py \
      --case @realist \
      --variants sequential,mpi-4 \
      --title debug_realist \
      --debug \
      --rebuild \
      --host host_ci \
      --data-root-path $DATAROOTPATH \
      --html -N --report --no_date_in_result_dir
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week
    reports:
      junit: BENCH/results/debug_realist-host_ci/junit_report.xml

restart_realist:
  stage: bench
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/ubuntu_gfortran_parallel:2.0.0
  script:
    - cd $CI_PROJECT_DIR/BENCH
    - |
      ./bench-croco.py \
      --case @realist \
      --variants mpi-4 \
      --compare-to mpi-4 \
      --title restart_realist \
      --restart \
      --rebuild \
      --host host_ci \
      --data-root-path $DATAROOTPATH \
      --html -N --report --no_date_in_result_dir
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week
    reports:
      junit: BENCH/results/restart_realist-host_ci/junit_report.xml

plotphy_realist:
  stage: bench
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/ubuntu_gfortran_parallel:2.0.0
  script:
    - cd $CI_PROJECT_DIR/BENCH
    - |
      ./bench-croco.py \
      --case BENGUELA_LR_TIDES_BULK \
      --variants mpi-4 \
      --title plotphy_realist \
      -s build,run,plotphy \
      --rebuild \
      --host host_ci \
      --data-root-path $DATAROOTPATH \
      --html -N --report --no_date_in_result_dir
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week
    reports:
      junit: BENCH/results/plotphy_realist-host_ci/junit_report.xml

agrif_realist:
  stage: bench
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/ubuntu_gfortran_parallel:2.0.0
  script:
    - cd $CI_PROJECT_DIR/BENCH
    - |
      ./bench-croco.py \
      --case @agrif_realist \
      --variants @debug \
      --title agrif_realist \
      --debug \
      --rebuild \
      --host host_ci \
      --data-root-path $DATAROOTPATH \
      --html -N --report --no_date_in_result_dir
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week
    reports:
      junit: BENCH/results/agrif_realist-host_ci/junit_report.xml


debug_complement:
  stage: bench
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/debian_gfortran:2.0.0
  script:
    - cd $CI_PROJECT_DIR/BENCH
    - source /venv/bin/activate
    - |
      ./bench-croco.py \
      --case @complement \
      --variants @debug \
      --title debug-complement \
      --debug \
      --rebuild \
      --host host_ci \
      --html \
      -N --report --no_date_in_result_dir
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week
    reports:
      junit: BENCH/results/debug-complement-host_ci/junit_report.xml


# space disk issue if we want to do plotphy on all complement cases
# to split ?

# plotphy_complement:
#   stage: bench
#   tags:
#     - ci.inria.fr
#     - large
#   image : registry.gitlab.inria.fr/croco-ocean/croco_docker/debian_gfortran:2.0.0
#   script:
#     - cd $CI_PROJECT_DIR/BENCH
#     - source /venv/bin/activate
#     - |
#       ./bench-croco.py \
#       --case @complement \
#       --variants mpi-2 \
#       --title plotphy-complement \
#       -s build,run,plotphy \
#       --rebuild \
#       --host host_ci \
#       --html \
#       -N --report --no_date_in_result_dir
#   artifacts:
#     paths:
#       - BENCH/results
#     when: always
#     expire_in: 1 week
#     reports:
#       junit: BENCH/results/plotphy-complement-host_ci/junit_report.xml

pages:
  stage: report
  tags:
    - ci.inria.fr
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/ubuntu_gfortran_parallel:2.0.0
  script:
    - mkdir -p $CI_PROJECT_DIR/public/dev
    - cd $CI_PROJECT_DIR/BENCH
    - ./bench-croco.py --globalhtml
    - cp -R $CI_PROJECT_DIR/BENCH/results $CI_PROJECT_DIR/public/dev
  artifacts:
    paths:
      - public
    when: always
    expire_in: 1 week
  when: always
