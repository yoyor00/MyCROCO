# ci croco
stages:
  - perfrst
  - bench
  - report

variables:
  TERM: "xterm-256color"
  CVTKHOME: "$CI_PROJECT_DIR/CVTK/test_repro"
  PERFRSTHOME: "$CI_PROJECT_DIR/CVTK/test_perfrst"
  #
  DATADIR: "$CI_PROJECT_DIR/.datadir"
  PERFRSTDIR: "$CI_PROJECT_DIR/.perfrstdir"
  #
  DATAREG: "/data/ForCI-INRIA/VHR_CROCO_FILES_BCK"
  DATAROOTPATH: "/data"
  #
  # use in case of local gitlab-runner; put VHR_CROCO_FILES_BCK at same level than croco
  # e.g : 
  # gcambon lpo 4096 mars  22 14:29 croco
  # gcambon lpo   43 juin  28  2023 VHR_CROCO_FILES_BCK
  #
  # In local job variables section, use of the local data
  DATAREG_LOCAL: "$CI_PROJECT_DIR/../../../../VHR_CROCO_FILES_BCK"
  # 
  # For parallel repro :
  # run local gitlab-runner using : gitlab-runner exec shell reg_run_[intel/gfortran] --env LOCALDATA="true" --timeout=7200
  # !! do not forget the flag LOCALDATA="true" !!
  #
  # For exact restart (aka perfrst) repro : 
  # run local gitlab-runner using : gitlab-runner exec shell reg_perfrst_[intel/gfortran] --env LOCALDATA="true" --timeout=7200
  # !! do not forget the flag LOCALDATA="true" !!
  #
  CI_CROCO_PWD: $(pwd)
  SOURCE_CROCO: "$CI_PROJECT_DIR/OCEAN"
  #
  # Here define the direcory with the input files
  # => for BENGUELA_VHR
  nest_position_reg: "79 137 37 117 3 3 3 3"
  # => for VORTEX if needed
  DATAVOR: ""
  nest_position_vort: ""
  # => for ANA if needed
  DATAANA: ""
  #

.gfortran_base: &gfortran_base
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/ubuntu_gfortran_parallel:1.0.0
  variables:
    CI_FC: "gfortran"
    CI_MPIF90: "mpif90"
    CROCO_CI_MPIRUN: "mpirun.openmpi --allow-run-as-root"
    CVTKWORK: "$CI_PROJECT_DIR/.datawork_gfortran"
    PERFRSTWORK: "$CI_PROJECT_DIR/.perfrstwork_gfortran"

.intel_base: &intel_base
  tags:
    - croco-vm-docker
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/ubuntu_intel_parallel:1.0.0
  variables:
    CI_FC: "ifort"
    CI_MPIF90: "mpiifort"
    CROCO_CI_MPIRUN: "mpirun"
    CVTKWORK: "$CI_PROJECT_DIR/.datawork_intel"
    PERFRSTWORK: "$CI_PROJECT_DIR/.perfrstwork_intel"

.get_reg_data: &get_reg_data # reusable block as YAML sequence
  - |
    if [[ "$LOCALDATA" == "true" ]]; then
      export DATAREG=${DATAREG_LOCAL} ;
      echo "Use of local data " $DATAREG ;
    else  
      cd /data;
      tar -xf ForCI-INRIA.tar.gz ;
      # clean unneeded files and directories to have enough space left for tests
      rm -Rf ForCI-INRIA.tar.gz;
      rm -Rf ForCI-INRIA/COASTAL_VILAINE_BCK;
      rm -Rf ForCI-INRIA/LR_CROCO_FILES_BCK;
      rm -Rf ForCI-INRIA/VORTEX_FILES_BCK;
      # check
      echo "Data for reg run ready :" $DATAREG
    fi   

.get_var_perfrst: &get_var_perfrst
  variables:
    RUN_HOME: $PERFRSTHOME
    RUN_WORK: $PERFRSTWORK
    RUN_MK: "mk_TESTALL_perfrst"
    RUN_GATHER: "gather_recap_perfrst"

.run_base:
  stage: perfrst
  script:
    - ulimit -s unlimited
    - mkdir -p $DATADIR
    - mkdir -p $CVTKWORK
    - mkdir -p $PERFRSTDIR
    - mkdir -p $PERFRSTWORK
    - cd $RUN_HOME/Scripts_${RUN_NAME_SCRIPT}
    - ./create_link_master_${RUN_NAME_SCRIPT}.sh
    - cd -
    - cd $RUN_WORK/${RUN_NAME}
    - ./${RUN_MK}.bash ${RUN_NAME_CONFIGURE} ${RUN_MK_NAME}
    - ./${RUN_GATHER}.bash ${RUN_NAME} > /dev/null 2>&1
    - /bin/sh -c '! grep -i "Compilation failure" ${RUN_NAME}_gather_recap_*_git*' > /dev/null 2>&1
    - /bin/sh -c '! grep -i "Execution failure" ${RUN_NAME}_gather_recap_*_git*' > /dev/null 2>&1
    - /bin/sh -c '! grep -i "Parallel reproducibility failed" ${RUN_NAME}_gather_recap_*_git*' > /dev/null 2>&1  
  artifacts:
    paths:
      - $RUN_WORK/ftp
      - $RUN_WORK/${RUN_NAME}/*/*.log
    when: always
    expire_in: 1 week

.reg_perfrst_base: &reg_perfrst_base
  extends: 
    - .run_base
    - .get_var_perfrst 
  before_script:
    - *get_reg_data
  variables:
    RUN_NAME: "REG"
    RUN_NAME_SCRIPT: "reg_perfrst"
    RUN_MK_NAME: "reg"
    RUN_NAME_CONFIGURE: "CONFIGURE_REG_PERFRST"
    RUNNER_SCRIPT_TIMEOUT: 120m
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"

reg_perfrst_gfortran:
  extends:
    - .gfortran_base
    - .reg_perfrst_base

reg_perfrst_intel:
  extends:
    - .intel_base
    - .reg_perfrst_base

test_bench_debug_jobcomp:
  stage: bench
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/debian_gfortran:2.0.0
  script:
    - cd $CI_PROJECT_DIR/BENCH
    - source /venv/bin/activate
    - |
      ./bench-croco.py \
      --case @base,@nbq,@sediment_mustang,@other,@complement \
      --variants @debug \
      --title debug_jobcomp \
      --debug \
      --jobcomp \
      --rebuild \
      --host host_ci \
      --html \
      -N --report
    - |
      cp BENCH/results/debug_jobcomp*/junit_report.xml \
      BENCH/results/debug_jobcomp_junit_report.xml
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week
    reports:
      junit: BENCH/results/*.xml

test_bench_debug_cmake:
  stage: bench
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/debian_gfortran:2.0.0
  script:
    - cd $CI_PROJECT_DIR/BENCH
    - source /venv/bin/activate
    - |
      ./bench-croco.py \
      --case @base,@nbq,@sediment_mustang,@other,@complement \
      --variants @debug \
      --title debug_cmake \
      --debug \
      --rebuild --host host_ci \
      --html \
      -N --report
    - |
      cp BENCH/results/debug_cmake*/junit_report.xml \
      BENCH/results/debug_cmake_junit_report.xml
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week
    reports:
      junit: BENCH/results/*.xml

test_bench_plotphy_jobcomp:
  stage: bench
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/debian_gfortran:2.0.0
  script:
    - cd $CI_PROJECT_DIR/BENCH
    - source /venv/bin/activate
    - |
      ./bench-croco.py \
      --case @base,@nbq,@sediment_mustang,@other,@complement \
      --variants mpi-2 \
      --title plotphy \
      -s build,run,plotphy \
      --jobcomp \
      --rebuild \
      --host host_ci \
      --html \
      -N --report
    - |
      cp BENCH/results/plotphy*/junit_report.xml \
      BENCH/results/plotphy_junit_report.xml
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week
    reports:
      junit: BENCH/results/*.xml

test_bench_debug_ifort_jobcomp:
  stage: bench
  tags:
    - croco-vm-docker
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/ubuntu_intel_parallel:2.0.0
  script:
    - cd $CI_PROJECT_DIR/BENCH
    #note : check step not available because sequential is not done here
    - |
      ./bench-croco.py \
      --case @base,@realist \
      --variants @debug-ifort \
      --title debug_ifort \
      --debug \
      --jobcomp  \
      --rebuild \
      --host host_ci \
      --steps build,run  \
      --data-root-path $DATAROOTPATH \
      --html -N --report
    - |
      cp BENCH/results/debug_ifort*/junit_report.xml \
      BENCH/results/debug_ifort_junit_report.xml
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week
    reports:
      junit: BENCH/results/*.xml
  when: manual

test_bench_realist:
  stage: bench
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/ubuntu_gfortran_parallel:2.0.0
  script:
    - cd $CI_PROJECT_DIR/BENCH
    - |
      ./bench-croco.py \
      --case @realist \
      --variants @debug \
      --title debug_realist \
      --debug \
      --jobcomp  \
      --rebuild \
      --host host_ci \
      --data-root-path $DATAROOTPATH \
      --html -N --report
    - |
      cp BENCH/results/debug_realist*/junit_report.xml \
      BENCH/results/debug_realist_junit_report.xml
    - |
      ./bench-croco.py \
      --case @realist \
      --variants mpi-4 \
      --title plotphy_realist \
      -s build,run,plotphy \
      --jobcomp  \
      --rebuild \
      --host host_ci \
      --data-root-path $DATAROOTPATH \
      --html -N --report
    - |
      cp BENCH/results/plotphy_realist*/junit_report.xml \
      BENCH/results/plotphy_realist_junit_report.xml
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week
    reports:
      junit: BENCH/results/*.xml

pages:
  stage: report
  tags:
    - ci.inria.fr
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/ubuntu_gfortran_parallel:2.0.0
  script:
    - mkdir -p $CI_PROJECT_DIR/public/dev
    - cd $CI_PROJECT_DIR/BENCH
    - ./bench-croco.py --globalhtml
    - cp -R $CI_PROJECT_DIR/BENCH/results $CI_PROJECT_DIR/public/dev
  artifacts:
    paths:
      - public
    when: always
    expire_in: 1 week
