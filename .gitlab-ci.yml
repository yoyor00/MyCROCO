# ci croco

stages:
  - bench
  - report

variables:
  TERM: "xterm-256color"
  DATAREG: "/data"

test_bench_debug:
  stage: bench
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/ubuntu_gfortran_parallel:1.0.0
  before_script:
    - cd $DATAREG ;
    - tar -xf ForCI-INRIA.tar.gz ;
  script:
    - cd $CI_PROJECT_DIR/BENCH
    - ./bench-croco.py --case @debug --variants @debug --jobcomp --rebuild --host host_ci --compare-to sequential-debug --data-root-path $DATAREG/ForCI-INRIA --html --title debug
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week

test_bench_debug_ifort:
  stage: bench
  tags:
    - croco-vm-docker
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/ubuntu_intel_parallel:1.0.0
  before_script:
    - cd $DATAREG ;
    - tar -xf ForCI-INRIA.tar.gz ;
  script:
    - cd $CI_PROJECT_DIR/BENCH
    #note : --jobs 1 mandatory with intel compiler
    #note : check not available because sequentiel is not done here
    - ./bench-croco.py --case @debug --variants @debug-ifort --jobcomp --rebuild --host host_ci_ifort --jobs 1 --steps build,run --data-root-path $DATAREG/ForCI-INRIA --html --title debug_ifort
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week

test_bench_regional:
  stage: bench
  tags:
    - ci.inria.fr
    - large
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/ubuntu_gfortran_parallel:1.0.0
  before_script:
    - cd $DATAREG ;
    - tar -xf ForCI-INRIA.tar.gz ;
  script:
    - cd $CI_PROJECT_DIR/BENCH
    - ./bench-croco.py --case BENGUELA_VHR_TIDES_BULK --variants sequential,mpi-4 --jobcomp --rebuild --host host_ci --data-root-path $DATAREG/ForCI-INRIA --html --title regional
  artifacts:
    paths:
      - BENCH/results
    when: always
    expire_in: 1 week


pages:
  stage: report
  tags:
    - ci.inria.fr
  image : registry.gitlab.inria.fr/croco-ocean/croco_docker/ubuntu_gfortran_parallel:1.0.0
  script:
    - mkdir -p $CI_PROJECT_DIR/public/$CI_COMMIT_REF_NAME
    - cd $CI_PROJECT_DIR/BENCH
    - ./bench-croco.py --globalhtml
    - cp -R $CI_PROJECT_DIR/BENCH/results $CI_PROJECT_DIR/public/$CI_COMMIT_REF_NAME
  artifacts:
    paths:
      - public
    when: always
    expire_in: 1 week
